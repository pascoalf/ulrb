<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ulrb">
<title>Integration of ulrb in a simple microbial ecology workflow • ulrb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Integration of ulrb in a simple microbial ecology workflow">
<meta property="og:description" content="ulrb">
<meta property="og:image" content="https://pascoalf.github.io/ulrb/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ulrb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Glossary.html">Glossary</a>
    <a class="dropdown-item" href="../articles/eco-analysis.html">Integration of ulrb in a simple microbial ecology workflow</a>
    <a class="dropdown-item" href="../articles/explore-classifications.html">Alternative classifications with ulrb</a>
    <a class="dropdown-item" href="../articles/ulrb-vignet.html">Tutorial to define rare biosphere with ulrb</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Integration of ulrb in a simple microbial ecology workflow</h1>
            
      
      
      <div class="d-none name"><code>eco-analysis.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="ecological-analysis-of-microbial-rare-biosphere-defined-by-ulrb">Ecological analysis of microbial rare biosphere defined by ulrb<a class="anchor" aria-label="anchor" href="#ecological-analysis-of-microbial-rare-biosphere-defined-by-ulrb"></a>
</h2>
<p>In this tutorial we will show how the output from
<code><a href="../reference/define_rb.html">define_rb()</a></code> can be readily used for some common ecological
analysis. In this case, we will just look at alpha diversity.</p>
<p>To do so, we have several steps:</p>
<ol style="list-style-type: lower-alpha">
<li>Load and clean OTU table (we just want prokaryotes);</li>
<li>Rarefy samples (we show this option, because it is very
common);</li>
<li>Classify OTUs into rare, undetermined or abundant (with
<code><a href="../reference/define_rb.html">define_rb()</a></code> function);</li>
<li>Merge OTU table with metadata information;</li>
<li>Calculate and plot alpha diversity metrics against environmental
variables.</li>
</ol>
<div class="section level3">
<h3 id="quick-overview-of-n-ice-dataset">Quick overview of N-ICE dataset<a class="anchor" aria-label="anchor" href="#quick-overview-of-n-ice-dataset"></a>
</h3>
<p>The N-ICE dataset consists of 9 samples, collected during the winter
to spring transition of 2015 by fixing the vessel on drifting ice
(Granskog et al., 2018). Samples were collected at various depths (from
5m to 250m) and the ice drifted across different regions, DNA was
collected for 16S amplicon sequencing and metagenomes (de Sousa et al.,
2019); and bioinformatic processing of reads was performed by Mgnify
platform (v5) (Mitchel et al., 2020).</p>
<p>For this tutorial we are using the OTU table downloaded from the link
<a href="https://www.ebi.ac.uk/metagenomics/studies/MGYS00001922#analysis" class="external-link uri">https://www.ebi.ac.uk/metagenomics/studies/MGYS00001922#analysis</a>
in 06-01-2023 and focus solely on the 16S amplicon data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pascoalf.github.io/ulrb/">ulrb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vegandevs/vegan" class="external-link">vegan</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: permute</span></span>
<span><span class="co">#&gt; Loading required package: lattice</span></span>
<span><span class="co">#&gt; This is vegan 2.6-4</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a-load-and-clean-otu-table">(a) Load and clean OTU table<a class="anchor" aria-label="anchor" href="#a-load-and-clean-otu-table"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load raw OTU table from N-ICE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"../data/nice_raw.rda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"../data/nice_env.rda"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change name of first column</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">nice_raw</span>, Taxonomy <span class="op">=</span> <span class="st">"X.SampleID"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select 16S rRNA amplicon sequencing samples</span></span>
<span><span class="va">selected_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ERR2044662"</span>, <span class="st">"ERR2044663"</span>, <span class="st">"ERR2044664"</span>,</span>
<span>                      <span class="st">"ERR2044665"</span>, <span class="st">"ERR2044666"</span>, <span class="st">"ERR2044667"</span>,</span>
<span>                      <span class="st">"ERR2044668"</span>, <span class="st">"ERR2044669"</span>, <span class="st">"ERR2044670"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a column with taxonomic units ID (OTU in this case)</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">nice_clean</span>, OTU <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"OTU_"</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select relevant collumns</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nice_clean</span>, <span class="va">selected_samples</span>, <span class="va">OTU</span>, <span class="va">Taxonomy</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using an external vector in selections was deprecated in tidyselect 1.1.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `all_of()` or `any_of()` instead.</span></span>
<span><span class="co">#&gt;   # Was:</span></span>
<span><span class="co">#&gt;   data %&gt;% select(selected_samples)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   # Now:</span></span>
<span><span class="co">#&gt;   data %&gt;% select(all_of(selected_samples))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span></span>
<span><span class="co"># Separate Taxonomy column into each taxonomic level</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span><span class="va">nice_clean</span>, <span class="va">Taxonomy</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Domain"</span>,<span class="st">"Kingdom"</span>,<span class="st">"Phylum"</span>,</span>
<span>                         <span class="st">"Class"</span>,<span class="st">"Order"</span>,<span class="st">"Family"</span>,<span class="st">"Genus"</span>,<span class="st">"Species"</span><span class="op">)</span>,</span>
<span>                       sep<span class="op">=</span><span class="st">";"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Expected 8 pieces. Missing pieces filled with `NA` in 912 rows [1, 2, 4, 5, 6,</span></span>
<span><span class="co">#&gt; 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, ...].</span></span>
<span></span>
<span><span class="co"># Remove Kingdom column, because it is not used for prokaryotes</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nice_clean</span>, <span class="op">-</span><span class="va">Kingdom</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove eukaryotes</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">nice_clean</span>, <span class="va">Domain</span> <span class="op">!=</span> <span class="st">"sk__Eukaryota"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove unclassified OTUs at phylum level</span></span>
<span><span class="va">nice_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">nice_clean</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Phylum</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simplify name</span></span>
<span><span class="va">nice</span> <span class="op">&lt;-</span> <span class="va">nice_clean</span></span>
<span></span>
<span><span class="co"># Check if everything looks normal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nice</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ERR2044662 ERR2044663 ERR2044664 ERR2044665 ERR2044666 ERR2044667 ERR2044668</span></span>
<span><span class="co">#&gt; 1        165        323         51         70        134        216          0</span></span>
<span><span class="co">#&gt; 2          0          0          1          0          0          1          0</span></span>
<span><span class="co">#&gt; 3          0          0          1          2          2          6          0</span></span>
<span><span class="co">#&gt; 4        541       1018        351        115        241       1633        177</span></span>
<span><span class="co">#&gt; 5          8          5         41         15         14        146          0</span></span>
<span><span class="co">#&gt; 6         15         31        590        133        174       1814         12</span></span>
<span><span class="co">#&gt;   ERR2044669 ERR2044670   OTU      Domain            Phylum</span></span>
<span><span class="co">#&gt; 1         11          0 OTU_2 sk__Archaea  p__Euryarchaeota</span></span>
<span><span class="co">#&gt; 2          0          0 OTU_3 sk__Archaea  p__Euryarchaeota</span></span>
<span><span class="co">#&gt; 3          0          0 OTU_4 sk__Archaea  p__Euryarchaeota</span></span>
<span><span class="co">#&gt; 4       1371          7 OTU_5 sk__Archaea  p__Euryarchaeota</span></span>
<span><span class="co">#&gt; 5         14          0 OTU_6 sk__Archaea p__Thaumarchaeota</span></span>
<span><span class="co">#&gt; 6        173          2 OTU_7 sk__Archaea p__Thaumarchaeota</span></span>
<span><span class="co">#&gt;                       Class                       Order Family</span></span>
<span><span class="co">#&gt; 1 c__Candidatus_Poseidoniia                        &lt;NA&gt;   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2 c__Candidatus_Poseidoniia o__Candidatus_Poseidoniales    f__</span></span>
<span><span class="co">#&gt; 3           c__Halobacteria          o__Halobacteriales   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4         c__Thermoplasmata                        &lt;NA&gt;   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5                      &lt;NA&gt;                        &lt;NA&gt;   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6                       c__                         o__    f__</span></span>
<span><span class="co">#&gt;                            Genus                                        Species</span></span>
<span><span class="co">#&gt; 1                           &lt;NA&gt;                                           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2                            g__ s__Marine_group_II_euryarchaeote_REDSEA-S03_B6</span></span>
<span><span class="co">#&gt; 3                           &lt;NA&gt;                                           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4                           &lt;NA&gt;                                           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5                           &lt;NA&gt;                                           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6 g__Candidatus_Nitrosopelagicus                                           &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Change table to tidy format</span></span>
<span><span class="co"># You can automatically do this with an ulrb function</span></span>
<span><span class="va">nice_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_tidy_data.html">prepare_tidy_data</a></span><span class="op">(</span><span class="va">nice</span>, <span class="co">## data to tidy </span></span>
<span>                  sample_names <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"ERR"</span><span class="op">)</span>, <span class="co">## vector with ID samples</span></span>
<span>                  samples_in <span class="op">=</span> <span class="st">"cols"</span><span class="op">)</span> <span class="co">## samples can be in columns (cols) or rows. </span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="b-rarefy-samples">(b) Rarefy samples<a class="anchor" aria-label="anchor" href="#b-rarefy-samples"></a>
</h3>
<p>Now that we have a tidy table, it will be important to keep in mind
how the data is organized. In this tutorial, we will be using functions
like <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> or <code><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest()</a></code>, if you are not
familiarized with them, try to search for tidyverse packages, functions
and mindset. We are also going to use the package vegan, which can be
used for most ecology statistics. Note, however, that vegan works with
matrices in very specific formats, so hopefully this sections will also
help you to see how you can use tidy verse approaches to very specific
data types.</p>
<p>The first step will be to verify how many reads each sample got</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## First, check how many reads each sample got</span></span>
<span><span class="va">nice_tidy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">## because data is in tidy format</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>TotalReads <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Abundance</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">TotalReads</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">40000</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="eco-analysis_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>All samples have more than about 50 000 reads, with one sample having
a little bit less. But we think we can keep all samples and rarefy down
to 40 000 reads.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_rarefid</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">nice_tidy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Rarefied_reads <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">data</span>, </span>
<span>                              <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span></span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span></span>
<span>                                  <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/rarefy.html" class="external-link">rrarefy</a></span><span class="op">(</span></span>
<span>                                    <span class="va">.x</span><span class="op">$</span><span class="va">Abundance</span>, </span>
<span>                                    sample <span class="op">=</span> <span class="fl">40000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">Rarefied_reads</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Rarefied_abundance <span class="op">=</span> <span class="st">"V1"</span><span class="op">)</span>  </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="b-classify-otus-into-rare-undetermined-or-abundant-with-define_rb-function">(b) Classify OTUs into rare, undetermined or abundant (with
<code>define_rb()</code> function);<a class="anchor" aria-label="anchor" href="#b-classify-otus-into-rare-undetermined-or-abundant-with-define_rb-function"></a>
</h3>
<p>At this stage, we can simply apply the <code><a href="../reference/define_rb.html">define_rb()</a></code>
function, which will include a nesting and grouping step inside of
itself. For this reason, the data does not need to be grouped before the
function. During unit testing, however, we noticed that this could
introduce problems, so the function implicitly removes any grouping of
the tidy table used by the author. This way, only the pre-specific
grouping of the function is used. To have control over this, you just
need to be careful with the sample column, because ulrb method assumes
that the calculations are made “by sample” – so, it will do an
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup()</a></code> followed by <code>group_by(Sample)</code>.</p>
<p>In practice, this is very simple:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_rb.html">define_rb</a></span><span class="op">(</span><span class="va">nice_tidy</span>, simplified <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(Sample, Level)`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nice_classified</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 17</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   Sample, Classification [1]</span></span></span>
<span><span class="co">#&gt;   Sample     Classification OTU   Domain Phylum Class Order Family Genus Species</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ERR2044662 Rare           OTU_2 sk__A… p__Eu… c__C… <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ERR2044662 Rare           OTU_5 sk__A… p__Eu… c__T… <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ERR2044662 Rare           OTU_6 sk__A… p__Th… <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ERR2044662 Rare           OTU_7 sk__A… p__Th… c__   o__   f__    g__C… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ERR2044662 Rare           OTU_8 sk__A… p__Th… c__   o__N… <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ERR2044662 Rare           OTU_… sk__A… p__Th… c__   o__N… f__Ni… g__N… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: Abundance &lt;int&gt;, pam_object &lt;list&gt;, Level &lt;fct&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   Silhouette_scores &lt;dbl&gt;, Cluster_median_abundance &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   median_Silhouette &lt;dbl&gt;, Evaluation &lt;chr&gt;</span></span></span></code></pre></div>
<p>By default, the function can give lots of details, but in this case,
since we are just going to look at the ecology component, and not at the
machine learning aspects of this, we can set the argument
<em>simplified</em> to <code>TRUE</code>. Note that the additional
computational time required for the additional details should be
negligible for small datasets (we don’t know how it behaves for bigger
datasets).</p>
</div>
<div class="section level3">
<h3 id="c-merge-otu-table-with-metadata-information">(c) Merge OTU table with metadata information<a class="anchor" aria-label="anchor" href="#c-merge-otu-table-with-metadata-information"></a>
</h3>
<p>We are almost ready to analyze ecological questions, but first we
need metadata. All we have to do is merge our classified OTU table with
the metadata table. To do this we will use join functions from dplyr,
just note that the sample ID from the two tables that we want to merge
are different, but this is easy to solve.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_eco</span> <span class="op">&lt;-</span> <span class="va">nice_classified</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">nice_env</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample"</span> <span class="op">=</span> <span class="st">"ENA_ID"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="e-calculate-and-plot-diversity-metrics-against-environmental-variables-">(e) Calculate and plot diversity metrics against environmental
variables.<a class="anchor" aria-label="anchor" href="#e-calculate-and-plot-diversity-metrics-against-environmental-variables-"></a>
</h3>
<p>At this point, we can calculate some common alpha diversity metrics.
If we use the dplyr and ggplot functions, then it becomes really easy to
make a simple overview of prokaryotic diversity, by classification.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate diversity</span></span>
<span><span class="va">nice_diversity</span> <span class="op">&lt;-</span> <span class="va">nice_eco</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">Classification</span>, <span class="va">Month</span>, <span class="va">Depth</span>, <span class="va">Water.mass</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>SpeciesRichness <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">specnumber</a></span><span class="op">(</span><span class="va">Abundance</span><span class="op">)</span>,</span>
<span>            ShannonIndex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">diversity</a></span><span class="op">(</span><span class="va">Abundance</span>, index <span class="op">=</span> <span class="st">"shannon"</span><span class="op">)</span>,</span>
<span>            SimpsonIndex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">diversity</a></span><span class="op">(</span><span class="va">Abundance</span>, index <span class="op">=</span> <span class="st">"simpson"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'Sample', 'Classification', 'Month',</span></span>
<span><span class="co">#&gt; 'Depth'. You can override using the `.groups` argument.</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Re-organize table to have all diversity indices in a single col.</span></span>
<span><span class="va">nice_diversity_tidy</span> <span class="op">&lt;-</span> <span class="va">nice_diversity</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SpeciesRichness"</span>, <span class="st">"ShannonIndex"</span>, <span class="st">"SimpsonIndex"</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"Index"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"Diversity"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span><span class="co"># correct order</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Month</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"March"</span>, <span class="st">"April"</span>, <span class="st">"June"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span><span class="co"># edit diversity index names</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Index <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Index</span> <span class="op">==</span> <span class="st">"ShannonIndex"</span> <span class="op">~</span> <span class="st">"Shannon Index"</span>,</span>
<span>                           <span class="va">Index</span> <span class="op">==</span> <span class="st">"SimpsonIndex"</span> <span class="op">~</span> <span class="st">"Simpson Index"</span>,</span>
<span>                           <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Number of OTUs"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># order diversity index names</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Index</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Number of OTUs"</span>, <span class="st">"Shannon Index"</span>,<span class="st">"Simpson Index"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="alpha-diversity-plots">Alpha diversity plots<a class="anchor" aria-label="anchor" href="#alpha-diversity-plots"></a>
</h4>
<p>At this stage, we have everything in a single tidy data.frame, which
makes ggplot plots straightforward.</p>
<ul>
<li>Month variation</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qualitative_colors</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plots</span></span>
<span><span class="va">nice_diversity_tidy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Month</span>, <span class="va">Diversity</span>, col <span class="op">=</span> <span class="va">Classification</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Index</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">qualitative_colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Classification: "</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Alpha diversity across month"</span><span class="op">)</span></span></code></pre></div>
<p><img src="eco-analysis_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<ul>
<li>Water mass variation</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_diversity_tidy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Water.mass</span>, <span class="va">Diversity</span>, col <span class="op">=</span> <span class="va">Classification</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Index</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">qualitative_colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Classification: "</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Alpha diversity across water mass"</span><span class="op">)</span></span></code></pre></div>
<p><img src="eco-analysis_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
</div>
<div class="section level4">
<h4 id="beta-diversity">Beta diversity<a class="anchor" aria-label="anchor" href="#beta-diversity"></a>
</h4>
<p>We can also do some basic beta diversity. Note that it might require
a little bit more of data wrangling.</p>
<p>In this section, we will only focus on the rare biosphere.</p>
<ul>
<li>Months</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rare_biosphere</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">nice_eco</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Classification</span> <span class="op">==</span> <span class="st">"Rare"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">Abundance</span>, <span class="va">OTU</span>, <span class="va">Depth</span>, <span class="va">Month</span>, <span class="va">Water.mass</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Sample_unique <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">Month</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Adding missing grouping variables: `Classification`</span></span>
<span></span>
<span><span class="va">rb_env</span> <span class="op">&lt;-</span> <span class="va">rare_biosphere</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sample_unique</span>, <span class="va">Depth</span>, <span class="va">Water.mass</span>, <span class="va">Month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rb_sp_prep</span> <span class="op">&lt;-</span> <span class="va">rare_biosphere</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sample_unique</span>, <span class="va">Abundance</span>, <span class="va">OTU</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rb_sp_prep</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># sanity check</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   Sample_unique    Abundance OTU   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ERR2044662 March       165 OTU_2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ERR2044662 March       541 OTU_5 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ERR2044662 March         8 OTU_6 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ERR2044662 March        15 OTU_7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ERR2044662 March         5 OTU_8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ERR2044662 March         4 OTU_10</span></span>
<span></span>
<span><span class="va">rb_sp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">rb_sp_prep</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"OTU"</span>,</span>
<span>                     values_from <span class="op">=</span> <span class="st">"Abundance"</span>,</span>
<span>                     values_fn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>count<span class="op">=</span> <span class="va">list</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/chop.html" class="external-link">unchop</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 523</span></span></span>
<span><span class="co">#&gt;   Sample_unique OTU_2 OTU_5 OTU_6 OTU_7 OTU_8 OTU_10 OTU_15 OTU_17 OTU_21 OTU_22</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ERR2044662 M…   165   541     8    15     5      4     19      1     61    123</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ERR2044663 M…   323  <span style="text-decoration: underline;">1</span>018     5    31    10      2     30      1     83    296</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ERR2044664 M…    51   351    41   590     7     24    377     <span style="color: #BB0000;">NA</span>      2    209</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ERR2044665 A…    70   115    15   133     3     11    102      1     30    308</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ERR2044666 A…   134   241    14   174    10     10     83      1     48    405</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ERR2044667 A…   216    <span style="color: #BB0000;">NA</span>   146    <span style="color: #BB0000;">NA</span>    16    136     <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>      5     <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> ERR2044669 J…    11    <span style="color: #BB0000;">NA</span>    14   173     8     12     19      2    108    183</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> ERR2044668 J…    <span style="color: #BB0000;">NA</span>   177    <span style="color: #BB0000;">NA</span>    12    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>      4      2    132    165</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> ERR2044670 J…    <span style="color: #BB0000;">NA</span>     7    <span style="color: #BB0000;">NA</span>     2    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>      1      1     12     12</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 512 more variables: OTU_23 &lt;int&gt;, OTU_26 &lt;int&gt;, OTU_29 &lt;int&gt;, OTU_30 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_31 &lt;int&gt;, OTU_39 &lt;int&gt;, OTU_40 &lt;int&gt;, OTU_44 &lt;int&gt;, OTU_47 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_48 &lt;int&gt;, OTU_57 &lt;int&gt;, OTU_58 &lt;int&gt;, OTU_66 &lt;int&gt;, OTU_70 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_76 &lt;int&gt;, OTU_89 &lt;int&gt;, OTU_91 &lt;int&gt;, OTU_92 &lt;int&gt;, OTU_95 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_97 &lt;int&gt;, OTU_99 &lt;int&gt;, OTU_100 &lt;int&gt;, OTU_101 &lt;int&gt;, OTU_103 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_104 &lt;int&gt;, OTU_105 &lt;int&gt;, OTU_106 &lt;int&gt;, OTU_108 &lt;int&gt;, OTU_110 &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OTU_120 &lt;int&gt;, OTU_121 &lt;int&gt;, OTU_122 &lt;int&gt;, OTU_128 &lt;int&gt;, …</span></span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rb_sp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">rb_sp</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Prepare aesthetics</span></span>
<span><span class="va">rb_env</span> <span class="op">&lt;-</span> <span class="va">rb_env</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>col_month <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Month</span> <span class="op">==</span> <span class="st">"March"</span> <span class="op">~</span> <span class="va">qualitative_colors</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                               <span class="va">Month</span> <span class="op">==</span> <span class="st">"April"</span> <span class="op">~</span> <span class="va">qualitative_colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                               <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">qualitative_colors</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cca_plot_rare_biosphere</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/cca.html" class="external-link">cca</a></span><span class="op">(</span><span class="va">rb_sp</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, display <span class="op">=</span> <span class="st">"sites"</span>, scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>display <span class="op">=</span> <span class="st">"sites"</span>, type <span class="op">=</span> <span class="st">"p"</span>, main <span class="op">=</span> <span class="st">"Rare biosphere"</span><span class="op">)</span></span>
<span><span class="co">#</span></span>
<span><span class="va">cca_plot_rare_biosphere</span></span>
<span><span class="co">#&gt; $default</span></span>
<span><span class="co">#&gt;             CA1        CA2</span></span>
<span><span class="co">#&gt; sit1 -0.7896653  0.8503868</span></span>
<span><span class="co">#&gt; sit2 -0.8239607  0.9143530</span></span>
<span><span class="co">#&gt; sit3 -0.2497625 -1.1717369</span></span>
<span><span class="co">#&gt; sit4 -0.3886150 -1.0134637</span></span>
<span><span class="co">#&gt; sit5 -0.7702444  0.1222861</span></span>
<span><span class="co">#&gt; sit6 -0.5394403 -3.0662464</span></span>
<span><span class="co">#&gt; sit7  0.9769221 -0.3825371</span></span>
<span><span class="co">#&gt; sit8  1.6462283  0.3933325</span></span>
<span><span class="co">#&gt; sit9  1.5573013  0.3989370</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "ordiplot"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cca_plot_rare_biosphere</span>,</span>
<span>       bg <span class="op">=</span> <span class="va">rb_env</span><span class="op">$</span><span class="va">col_month</span>,</span>
<span>       pch <span class="op">=</span> <span class="fl">21</span>, </span>
<span>       col <span class="op">=</span> <span class="st">"grey"</span>, </span>
<span>       cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">rb_env</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/ordihull.html" class="external-link">ordispider</a></span><span class="op">(</span><span class="va">cca_plot_rare_biosphere</span>,</span>
<span>                <span class="va">Month</span>, lty <span class="op">=</span> <span class="st">"dashed"</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="eco-analysis_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>From this analysis, it seems that the community composition of the
rare biosphere is different between June and the remaining months.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="final-considerations">Final considerations<a class="anchor" aria-label="anchor" href="#final-considerations"></a>
</h2>
<p>Hopefully, you got a sense of how the ulrb package can be integrated
in a more general microbial ecology workflow. Of course, many more
questions could be approached, such as taxonomy and so on. This was
meant to serve as an example of how ulrb can be trivially integrated in
a data analysis workflow.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p>de Sousa, A. G. G., Tomasino, M. P., Duarte, P.,
Fernández-Méndez, M., Assmy, P., Ribeiro, H., Surkont, J., Leite, R. B.,
Pereira-Leal, J. B., Torgo, L., &amp; Magalhães, C. (2019). Diversity
and Composition of Pelagic Prokaryotic and Protist Communities in a Thin
Arctic Sea-Ice Regime. Microbial Ecology, 78(2), 388–408.</p></li>
<li><p>Mitchell, A. L., Almeida, A., Beracochea, M., Boland, M., Burgin,
J., Cochrane, G., Crusoe, M. R., Kale, V., Potter, S. C., Richardson, L.
J., Sakharova, E., Scheremetjew, M., Korobeynikov, A., Shlemov, A.,
Kunyavskaya, O., Lapidus, A., &amp; Finn, R. D. (2019). MGnify: the
microbiome analysis resource in 2020. Nucleic Acids Research, 48(D1),
D570–D578.</p></li>
<li><p>Granskog, M. A., Fer, I., Rinke, A., &amp; Steen, H. (2018).
Atmosphere-Ice-Ocean-Ecosystem Processes in a Thinner Arctic Sea Ice
Regime: The Norwegian Young Sea ICE (N-ICE2015) Expedition. Journal of
Geophysical Research: Oceans, 123(3), 1586–1594.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Francisco Pascoal, Paula Branco, Luís Torgo, Rodrigo Costa, Catarina Magalhães.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
